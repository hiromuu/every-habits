# フロー図

## 1. システム全体フロー

### 1.1 メインフロー

```
┌─────────────────┐
│   アプリ起動    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   ホーム画面    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   機能選択      │
└─────────┬───────┘
          │
    ┌─────┴─────┐
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│理想習慣 │ │今日の提案│
│設定画面 │ │画面      │
└─────────┘ └─────────┘
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│習慣保存 │ │提案表示 │
└─────────┘ └─────────┘
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│ログ・   │ │フィード │
│ふりかえり│ │バック   │
│画面      │ │記録     │
└─────────┘ └─────────┘
```

## 2. 詳細フロー

### 2.1 理想習慣設定フロー

```
┌─────────────────┐
│   設定画面開始  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   既存データ    │
│   読み込み      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   習慣入力      │
│   (朝・夜)      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   バリデーション│
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   データ保存    │
│   (Firebase)    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   保存完了      │
│   メッセージ    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   ホーム画面    │
│   に戻る        │
└─────────────────┘
```

### 2.2 提案表示フロー

```
┌─────────────────┐
│   提案画面開始  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   時間帯判定    │
│   (朝・夜)      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   提案データ    │
│   取得          │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   フィルタリング│
│   (受容率等)    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   提案表示      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   ユーザー操作  │
│   (時間帯変更)  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   提案再取得    │
└─────────────────┘
```

### 2.3 フィードバック処理フロー

```
┌─────────────────┐
│   提案表示中    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   フィードバック│
│   ボタン押下    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   コメント入力  │
│   (任意)        │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   データ作成    │
│   (フィードバック)│
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   Firebase保存  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   統計更新      │
│   (受容率等)    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   次の提案表示  │
└─────────────────┘
```

### 2.4 AI 提案生成フロー

```
┌─────────────────┐
│   AI提案要求    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   ユーザー習慣  │
│   データ取得    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   GPT API呼び出し│
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   レスポンス    │
│   パース        │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   提案データ    │
│   作成          │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   Firebase保存  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   提案表示      │
└─────────────────┘
```

## 3. エラーハンドリングフロー

### 3.1 ネットワークエラー処理

```
┌─────────────────┐
│   ネットワーク  │
│   エラー発生    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   ローカル      │
│   キャッシュ確認│
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   キャッシュ    │
│   データ表示    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   エラーメッセージ│
│   表示          │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   再試行ボタン  │
│   表示          │
└─────────────────┘
```

### 3.2 データ検証エラー処理

```
┌─────────────────┐
│   データ入力    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   バリデーション│
│   実行          │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   エラー有無    │
│   判定          │
└─────────┬───────┘
          │
    ┌─────┴─────┐
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│エラーなし│ │エラーあり│
└─────────┘ └─────────┘
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│処理続行 │ │エラーメッ│
└─────────┘ │セージ表示│
            └─────────┘
```

## 4. 認証フロー

### 4.1 ログインフロー

```
┌─────────────────┐
│   アプリ起動    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   認証状態確認  │
└─────────┬───────┘
          │
    ┌─────┴─────┐
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│認証済み │ │未認証   │
└─────────┘ └─────────┘
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│ホーム画面│ │ログイン │
│表示      │ │画面表示 │
└─────────┘ └─────────┘
                    │
                    ▼
            ┌─────────────┐
            │   ログイン  │
            │   処理      │
            └─────┬───────┘
                  │
                  ▼
            ┌─────────────┐
            │   認証成功  │
            │   判定      │
            └─────┬───────┘
                  │
            ┌─────┴─────┐
            │           │
            ▼           ▼
        ┌─────────┐ ┌─────────┐
        │成功     │ │失敗     │
        └─────────┘ └─────────┘
            │           │
            ▼           ▼
        ┌─────────┐ ┌─────────┐
        │ホーム画面│ │エラーメッ│
        │表示      │ │セージ表示│
        └─────────┘ └─────────┘
```

## 5. データ同期フロー

### 5.1 オンライン・オフライン同期

```
┌─────────────────┐
│   ネットワーク  │
│   状態確認      │
└─────────┬───────┘
          │
    ┌─────┴─────┐
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│オンライン│ │オフライン│
└─────────┘ └─────────┘
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│リアルタイム│ │ローカル │
│同期      │ │キャッシュ│
└─────────┘ └─────────┘
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│Firebase │ │AsyncStor│
│同期     │ │age使用   │
└─────────┘ └─────────┘
```

## 6. 画面遷移フロー

### 6.1 画面遷移図

```
┌─────────────────┐
│   スプラッシュ  │
│   画面          │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   ログイン      │
│   画面          │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   ホーム画面    │
└─────────┬───────┘
          │
    ┌─────┴─────┐
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│理想習慣 │ │今日の提案│
│設定画面 │ │画面      │
└─────────┘ └─────────┘
    │           │
    ▼           ▼
┌─────────┐ ┌─────────┐
│ログ・   │ │フィード │
│ふりかえり│ │バック   │
│画面      │ │画面      │
└─────────┘ └─────────┘
```

## 7. 処理フロー

### 7.1 提案選択アルゴリズム

```
┌─────────────────┐
│   提案要求      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   時間帯取得    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   提案データ    │
│   取得          │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   フィルタリング│
│   (アクティブ)  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   重み付け計算  │
│   (受容率等)    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   ランダム選択  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   提案返却      │
└─────────────────┘
```

### 7.2 統計計算フロー

```
┌─────────────────┐
│   統計要求      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   フィードバック│
│   データ取得    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   集計処理      │
│   (受容・拒否)  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   比率計算      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   統計データ    │
│   返却          │
└─────────────────┘
```
